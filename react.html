
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=700,maximum-scale=1.0,user-scalable=yes">
        <title>H2OWSOME</title>
        <style>
            body {margin: 20px 0px 0px 0px; padding: 0; background-image:url(wave_background4.png); background-position: top center; background-color: #93ced2; background-repeat: no-repeat; background-size:100% auto;}

            iframe {
                display:block;
                border:0;
            }
						
			.notYet {
				color: #999;
			}
			
			.current {
				color: #3CF;
			}
			
			.already { 
				color: #30C;
			}
			
			#links p {
				display: inline;
				margin-right: 10px;
			}
        </style>
		<script src="http://d3js.org/d3.v2.js"></script>
        <script src="http://a.vimeocdn.com/js/froogaloop2.min.js"></script>   

		<script type="text/javascript">
			var wh=window.innerHeight, ww=window.innerWidth;
			var videoTime=0, videoPercent=0;
			var numbers;
			var storyActive;
			var froogaloop;
			var isMoving = false;
			var data = [
				{
					label : "story1",
					cuePointBegin: 5.000,
					cuePointEnd: 10.000,
					story: "reveal1"
				},
				{
					label : "story2",
					cuePointBegin: 12.000,
					cuePointEnd: 20.000,
					story: "reveal2"
					
				},
				{
					label : "story3",
					cuePointBegin: 20.000,
					cuePointEnd: 30.000,
					story: "reveal3"
				}
			];
			
			function currentIcon(videoTime) {
				for(var i in data) {
					var d = data[i];
					if (d.cuePointBegin <= videoTime && videoTime < d.cuePointEnd) {
						return d;
					}
				}
				return null
			}
	   
			function iconColor(d){
				if (videoTime < d.cuePointBegin){
					return "#999";	
				} 
				if (videoTime >= d.cuePointEnd) {
					return "#30C";
				}
				return "#3CF";
			}
			
			function iconSize(d){
				var normalSize = "16px";
				var highlightedSize = "40px";
				if (videoTime < d.cuePointBegin){
					return normalSize;	
				} 
			
				if (videoTime >= d.cuePointEnd) {
					return normalSize;
				}
			
				return highlightedSize;
			}

			var previousIcon = null;
			function updateIcons(){
				
				var current = currentIcon(videoTime);

				if (videoTime < 5){
					current="begin";
				} else if (videoTime > 10 && videoTime < 12){
					current="betwee1and2";
				} else if (videoTime > 30){
					current="afterstories";
				}				

				if (previousIcon != current) {
					previousIcon = current;			
	   				numbers.transition()
				 	   .duration(1000)
					   .style("color",iconColor)
					   .style("font-size",iconSize);
				}
			}
			function pageLoad(){
				var container = document.getElementById("container");
				var videoFrame=d3.select("#player_1");
				var links=d3.select("#links");
				var revealFrames = d3.select("#revealHider").selectAll("iframe");
				var curStory, prevStory=null;
				//Animation Variables
				var onclickDuration=700;
				var clickedVidWidth = 300;
				var storyFrameTop = 90;
				
				numbers= links.selectAll("p").data(data);
				numbers.enter().append("p")
					.text(function(d){return d.label})
					.style("color",iconColor)
					.style("fontSize",iconSize);
					
				if(window.location.hash){
					storyActive = true;
					var location = String(window.location.hash)
					var storyFrame = d3.select(location);
					curStory = location.substr(1);
					prevStory = location.substr(1);
					storyFrame.style("display","block").style("margin-top", storyFrameTop+"px");
					videoFrame.style("width",clickedVidWidth+"px").style("height", clickedVidWidth*9/16+"px");
				}
				
				function showReveal(){
					isMoving = true;
					d3.select("#"+curStory)
						.style("display","block")
						.transition()
							.ease("exp-in-out")
							.duration(onclickDuration)
							.style("margin-top",storyFrameTop+"px");
					isMoving = false;
				}
				
				function hideReveal(){
					isMoving = true;
					d3.select("#"+prevStory)
						.transition()
							.duration(onclickDuration-250)
							.style("margin-top",wh*1+"px")
							.each("end",function(){
								revealFrames
									.style("display","none");
								if(storyActive){
									showReveal();
								} else {
									isMoving = false;	
								}
							})
				}
				function returnVid(){
					var containerWidth = container.offsetWidth;
					
					isMoving = true;
					storyActive=false;
					window.location.hash="";
					videoFrame
						.transition()
							.duration(onclickDuration)
							.style("width",containerWidth+"px")
							.style("height",containerWidth*9/16+"px");
					prevStory=null
					isMoving = false;
				}
				
				
				numbers.on("click", function(d){
					window.location.hash=d.story;
					curStory = d.story;
					storyActive = true;
					if(froogaloop){
						froogaloop.api('pause');
					}
					videoFrame
						.transition()
							.duration(onclickDuration)
							.style("width",clickedVidWidth+"px")
							.style("height", clickedVidWidth*9/16+"px");
							
					if(prevStory==null){
						showReveal();	
						storyChange()
					} else if (curStory != prevStory){
							hideReveal();
						storyChange()
					} else {
							hideReveal();
						returnVid();
						froogaloop.api('play');
					}
					
					function storyChange(){
						prevStory = curStory;
					}
				});
				
				updateIcons();
				
				//WINDOW RESIZING
				window.addEventListener('resize', windowResize, false);
				
				function windowResize(){
					var wh2=window.innerHeight;
					var ww2=window.innerWidth;
					
					if(wh2!=wh){//NEW HEIGHT
						wh = wh2;
						revealChange();
					} 
					if(ww2!=ww){//NEW WIDTH
						ww = ww2;
						vidSize();
					} 
				}
				
				vidSize();
				function vidSize(){
					var vidFrameWidth = parseInt(videoFrame.style("width"));
					videoFrame.style("height",vidFrameWidth*9/16+"px");

					if(videoFrame.style("width") != "100%" && !storyActive){
						videoFrame.style("width","100%");
					}
					
				}
	
				revealChange();
				function revealChange(){
					if(!storyActive){
						revealFrames.style("margin-top",wh*1+"px");
					}
					revealFrames.style("max-height",wh-90+"px");
				}
				
				//VIMEO VIMEO VIMEO//
				//DURATION = video time length; TIMEINT = TIMER THAT COUNTS SECONDS INTO VIDEO; ISPLAYING = SEES IF VIDEO IS PLAYING
				var duration;
				var timeInt;
				var isPlaying = false;
				fVideo = document.getElementById("player_1");


                $f(fVideo).addEvent('ready', ready);
                function ready(player_id) {
					
                    // Keep a reference to Froogaloop for this player
                    froogaloop = $f(player_id);
					
						froogaloop.addEvent('play', function(data) {
							timeInt=setInterval(function(){getTime()},50);
							if(storyActive){
								hideReveal();
								returnVid();
							}
						});
	
						froogaloop.addEvent('pause', function(data) {
							isPlaying = false;
							window.clearInterval(timeInt)
						});
					
						froogaloop.addEvent('seek', function(data) { 
							timeManip (data.seconds);
						});
					
					function getTime(){
						froogaloop.api('getCurrentTime', function (value, player_id) {
							timeManip (value);
						});
					}
					
					function timeManip(seconds){
						console.log(seconds);
						videoTime = seconds;
						videoPercent = seconds/duration;
						updateIcons();
					}
					
					froogaloop.api('getDuration', function (value, player_id) {
						duration = value;
					});

					//froogaloop.addEvent('finish', function(data) {});
                }
			}//END ONPAGELOAD
			
			function addEvent(element, eventName, callback) {
				
				if (element.addEventListener) {
					element.addEventListener(eventName, callback, false);
				}
				else {
					element.attachEvent(eventName, callback, false);
				}
			}	
        </script>
    </head>
    <body>
		<div id="links" style="position: fixed; bottom: 0; left: 45%; width: 1000%; margin: 0px auto;"></div>
    	<!--<div id="spin" style="position: fixed; top: 0;">zwater</div>-->
        <div id="wrapper">
            <div id="container" style="max-width: 1400px; width:80%; margin: 0px auto;">
				<div class="logo" style="float: left;"><a href="http://lukerpig.com/d3/react.html"><img src="logo.png"/></a></div>
				<div class="topLinks" style="float: right;">Link1 - Link2 - Link3</div>
				<div style="clear: both"></div>
				<div id="vid-container" style="width:100%; position: relative; margin: 0px auto;">
					<div style="postion: absolute; width: 13.1%; height: 5%; left: 3.7%; top: 88.6%; background-color: #36C">dx</div>
					<iframe id="player_1" src="http://player.vimeo.com/video/43933265?api=1&amp;player_id=player_1" frameborder="0" style="position: absolute; top: 0; width:100%;"></iframe>
				</div>
            </div>
		<div id="revealHider" style="position: fixed; top: 0; bottom: 0; left:0; right:0; border: 2px solid red; overflow: hidden; z-index:-1;">
				<iframe id="reveal1" src="story1.html" style="max-width: 1400px; width:80%; height: 100%; margin: 0 auto; display: none;"></iframe>
				<iframe id="reveal2" src="story2.html" style="max-width: 1400px; width:80%; height: 100%; margin: 0 auto; display: none;"></iframe>
				<iframe id="reveal3" src="story1.html" style="max-width: 1400px; width:80%; height: 100%; margin: 0 auto; display: none;"></iframe>
		</div>
        <script>
				
        </script>
		<script type='text/javascript'>
			pageLoad();
		</script>
    </body>
</html>